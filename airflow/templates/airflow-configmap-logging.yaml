apiVersion: v1
kind: ConfigMap
metadata:
  name: airflow-logging-config
  namespace: airflow
  labels:
    app: airflow
data:
  airflow_local_settings.py: |
    from airflow.config_templates.airflow_local_settings import DEFAULT_LOGGING_CONFIG
    from copy import deepcopy

    LOGGING_CONFIG = deepcopy(DEFAULT_LOGGING_CONFIG)

    # Ensure formatter exists
    if "airflow.task" not in LOGGING_CONFIG.get("formatters", {}):
        LOGGING_CONFIG.setdefault("formatters", {})["airflow.task"] = {
            "format": "%(asctime)s - %(name)s - %(levelname)s - %(message)s",
            "datefmt": "%Y-%m-%d %H:%M:%S",
        }

    # Add GCS task handler. Use Helm-safe escaping for Airflow Jinja placeholders:
    #    use {{`{{ ti.dag_id }}`}} so Helm emits literal "{{ ti.dag_id }}" into the ConfigMap.
    LOGGING_CONFIG["handlers"]["gcs.task"] = {
        "class": "airflow.providers.google.cloud.log.gcs_task_handler.GCSTaskHandler",
        "formatter": "airflow.task",
        "base_log_folder": "/opt/airflow/logs",
        "gcs_log_folder": "gs://pz-buck-888/logs",
        "gcp_key_path": None,
        "filename_template": "{{`{{ ti.dag_id }}`}}/{{`{{ ti.task_id }}`}}/{{`{{ ts }}`}}/{{`{{ try_number }}`}}.log",
    }

    # Attach handler to airflow.task logger
    LOGGING_CONFIG["loggers"].setdefault("airflow.task", {})
    LOGGING_CONFIG["loggers"]["airflow.task"]["handlers"] = ["gcs.task"]
